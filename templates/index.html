<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Evaluation ({{ item_id + 1 }} of {{ total_items }})</title>
    <style>
        /* --- Modern CSS Variables & Theme --- */
        :root {
            /* Color Palette */
            --brand-primary-dark: oklch(0.5216 0.1421 150.46);
            --brand-primary-light: oklch(0.6532 0.1421 150.46);
            --success-color: #2dce89;
            --danger-color: #f5365c;

            /* Neutral Palette */
            --background: #f8f9fe; /* Slightly cooler background */
            --surface: #ffffff;
            --border-color: #dee2e6; /* Softer border color */
            --text-primary: #212529; /* Higher contrast text */
            --text-secondary: #6c757d;

            /* Spacing & Sizing (8-Point Grid System) */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Shadows & Transitions */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow: hidden;
            line-height: 1.6;
        }

        /* --- Main Layout --- */
        .page-wrapper {
            display: flex;
            height: 100vh;
        }

        /* --- Left Column: Image Viewer --- */
        .image-viewer {
            /* IMPROVEMENT: Use flex-grow to take up remaining space */
            flex: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--brand-primary-dark);
            position: relative;
            overflow: hidden;
            cursor: crosshair;
            padding: var(--spacing-lg);
            /* IMPROVEMENT: Add a minimum width to prevent it from becoming too small */
            min-width: 300px;
        }

        .image-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            transform-origin: center center;
        }

        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            user-select: none;
            -webkit-user-drag: none;
        }

        .image-viewer.grabbing {
            cursor: grabbing !important;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            display: flex;
            gap: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.85); /* Slightly more transparent */
            padding: var(--spacing-sm);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--surface);
            color: var(--text-primary);
            border-radius: var(--spacing-sm);
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: var(--brand-primary-dark);
            color: white;
            transform: scale(1.05);
        }

        .zoom-level {
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            font-weight: 600;
            min-width: 60px;
            justify-content: center;
            color: var(--text-primary);
        }

        /* --- Right Column: Form --- */
        .form-container {
            /* IMPROVEMENT: Use flex basis for a default width, but allow it to grow and shrink. */
            flex: 1 1 420px;
            max-width: 450px; /* Set a max-width to keep it from getting too wide on large screens */
            min-width: 320px; /* Ensure it doesn't get too crushed */
            padding: var(--spacing-xl);
            background: var(--surface);
            overflow-y: auto;
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.07);
        }


        /* Custom Scrollbar */
        .form-container::-webkit-scrollbar {
            width: 8px;
        }
        .form-container::-webkit-scrollbar-track {
            background: var(--background);
        }
        .form-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 8px;
        }
        .form-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* --- Header --- */
        .header {
            margin-bottom: var(--spacing-xl);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .item-counter {
            background-color: var(--brand-primary-dark);
            color: white;
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            transition: var(--transition-fast);
        }

        .eval-id {
            background: var(--background);
            padding: var(--spacing-md);
            border-radius: var(--spacing-sm);
            border: 1px solid var(--border-color);
        }

        .eval-id strong {
            color: var(--brand-primary-dark);
            transition: var(--transition-fast);
            /* IMPROVEMENT: Allow long words to break and wrap to the next line */
            overflow-wrap: break-word;
            word-break: break-word;
        }

        /* --- Form Sections --- */
        .form-section {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--background);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: var(--transition-fast);
        }
        .form-section:hover {
            border-color: #ced4da;
            box-shadow: var(--shadow-sm);
        }

        .form-section h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
        }

        /* --- Radio Buttons --- */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .radio-label {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--surface);
            border: 2px solid var(--border-color);
            border-radius: var(--spacing-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .radio-label:hover {
            border-color: var(--random-accent-color, var(--brand-primary-light));
            background: color-mix(in srgb, var(--random-accent-color, var(--brand-primary-light)) 10%, transparent);
        }

        .radio-label input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            margin-right: var(--spacing-md);
            position: relative;
            transition: var(--transition-fast);
            /* IMPROVEMENT: prevent radio button from shrinking */
            flex-shrink: 0;
        }

        .radio-label input[type="radio"]:checked {
            border-color: var(--random-accent-color, var(--brand-primary-dark));
            background-color: var(--random-accent-color, var(--brand-primary-dark));
        }
        .radio-label input[type="radio"]:checked::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radio-label:has(input:checked) {
            border-color: var(--random-accent-color, var(--brand-primary-dark));
            background: color-mix(in srgb, var(--random-accent-color, var(--brand-primary-dark)) 10%, transparent);
        }

        /* --- Rating Stars --- */
        .rating-group {
            margin-bottom: 1.5rem;
        }

        .rating-group b {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rating-options {
            display: flex;
            gap: var(--spacing-sm);
             /* IMPROVEMENT: Allow rating buttons to wrap on small screens */
            flex-wrap: wrap;
        }
        .rating-options .radio-label {
            flex: 1;
            justify-content: center;
            padding: var(--spacing-sm);
            font-weight: 600;
            /* IMPROVEMENT: Ensure a minimum width so they don't get too squashed before wrapping */
            min-width: 40px;
        }

        /* --- Textarea --- */
        textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--spacing-md);
            font-size: 14px;
            font-family: inherit;
            border: 2px solid var(--border-color);
            border-radius: var(--spacing-sm);
            resize: vertical;
            transition: var(--transition-fast);
            background: var(--surface);
        }
        textarea:focus {
            outline: none;
            border-color: var(--brand-primary-dark);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand-primary-dark) 15%, transparent);
        }

        /* --- Navigation Buttons --- */
        .nav {
            margin-top: var(--spacing-xl);
            display: flex;
            gap: var(--spacing-md);
        }

        .nav button,
        .nav a {
            flex: 1;
            padding: 14px var(--spacing-lg);
            border: none;
            border-radius: var(--spacing-sm);
            font-size: 16px;
            font-weight: 600;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .nav button {
            background: var(--success-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .nav button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav a {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        .nav a:hover:not(.disabled) {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }
        .nav a.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--background);
        }

        /* --- Footer --- */
        .footer {
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .footer a {
            color: var(--brand-primary-dark);
            text-decoration: none;
            font-weight: 600;
        }
        .footer a:hover {
            text-decoration: underline;
        }

        /* --- Responsive Design --- */
        /* IMPROVEMENT: Use a wider breakpoint for a better transition */
        @media (max-width: 992px) {
            .page-wrapper {
                flex-direction: column;
                /* Allow scrolling on the main page for smaller viewports */
                overflow: auto;
            }
            .image-viewer {
                /* Set a reasonable height for the image in the column layout */
                min-height: 40vh;
            }
            .form-container {
                /* Allow the form to take full width and remove max-width constraint */
                flex-basis: auto;
                max-width: none;
                /* Reduce padding on smaller screens */
                padding: var(--spacing-lg);
            }
        }
    </style>
</head>
<body>

<div class="page-wrapper">
    <div class="image-viewer" id="imageViewer">
        <div class="image-container" id="imageContainer">
            <img id="evaluationImage" src="{{ item.web_path }}" alt="Evaluation Image">
        </div>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomOut()">−</button>
            <div class="zoom-level" id="zoomLevel">100%</div>
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="resetZoom()">⟲</button>
        </div>
    </div>

    <div class="form-container">
        <div class="header">
            <div class="header-top">
                <h3>Image Evaluation</h3>
                <span class="item-counter">{{ item_id + 1 }} / {{ total_items }}</span>
            </div>
            <div class="eval-id">
                ID: <strong>{{ item.eval_id }}</strong>
            </div>
        </div>

        <form action="/submit" method="post">
            <input type="hidden" name="current_item_id" value="{{ item_id }}">
            
            <!-- MODIFICATION: Added hidden input for the anonymous session ID -->
            <input type="hidden" name="session_id" id="sessionIdInput">

            <input type="hidden" name="eval_id" value="{{ item.eval_id }}">
            <input type="hidden" name="item_class" value="{{ item.class }}">
            <input type="hidden" name="item_metric" value="{{ item.metric }}">
            <input type="hidden" name="item_case" value="{{ item.case }}">
            {% if next_id is not none %}
                <input type="hidden" name="next_item_id" value="{{ next_id }}">
            {% endif %}

            <div class="form-section">
                <h4>1. Comparative Rating (Test vs. Comparison)</h4>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="comparative_rating" value="test_much_better" required>
                        Test is much better
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="comparative_rating" value="test_slightly_better">
                        Test is slightly better
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="comparative_rating" value="equal">
                        They are equal
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="comparative_rating" value="comparison_slightly_better">
                        Comparison is slightly better
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="comparative_rating" value="comparison_much_better">
                        Comparison is much better
                    </label>
                </div>
            </div>

            <div class="form-section">
                <h4>2. Absolute Quality Rating (1-5)</h4>
                <div class="rating-group">
                    <b>Test Image Rating</b>
                    <div class="rating-options">
                        <label class="radio-label">
                            <input type="radio" name="test_rating" value="1" required>
                            1
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="test_rating" value="2">
                            2
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="test_rating" value="3">
                            3
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="test_rating" value="4">
                            4
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="test_rating" value="5">
                            5
                        </label>
                    </div>
                </div>
                <div class="rating-group">
                    <b>Comparison Image Rating</b>
                    <div class="rating-options">
                        <label class="radio-label">
                            <input type="radio" name="comparison_rating" value="1" required>
                            1
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="comparison_rating" value="2">
                            2
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="comparison_rating" value="3">
                            3
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="comparison_rating" value="4">
                            4
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="comparison_rating" value="5">
                            5
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>3. Comments / Observed Flaws</h4>
                <textarea name="comments" placeholder="Optional: Describe any issues or notable features..."></textarea>
            </div>

            <div class="nav">
                {% if previous_id is not none %}
                    <a href="{{ url_for('evaluate_item', item_id=previous_id) }}">← Previous</a>
                {% else %}
                    <a class="disabled">← Previous</a>
                {% endif %}
                <button type="submit">
                    {% if next_id is not none %}
                        Save & Next →
                    {% else %}
                        Save & Finish ✓
                    {% endif %}
                </button>
            </div>
        </form>
        
        <div class="footer">
            <p><strong>Controls:</strong> Scroll to zoom • Drag to pan • Double-click to reset</p>
            <p>Need to start over? <a href="#" onclick="localStorage.removeItem('qualEval_lastCompletedId'); window.location.href='/';">Reset Progress</a></p>
        </div>
    </div>
</div>

<script>
// --- SCRIPT 1: CLIENT-SIDE PROGRESS SAVING & RESUMING ---
// This script runs immediately to check for redirects.
(function() {
    const progressKey = 'qualEval_lastCompletedId';
    const currentItemId = {{ item_id }};
    const previousItemId = {{ previous_id if previous_id is not none else 'null' }};

    // Part 1: Save progress from the previous step
    if (previousItemId !== null) {
        localStorage.setItem(progressKey, previousItemId);
        console.log(`Progress saved. Last completed ID: ${previousItemId}`);
    }

    // Part 2: Resume session if visiting the first page
    if (currentItemId === 0) {
        const savedProgress = localStorage.getItem(progressKey);
        if (savedProgress !== null) {
            const lastCompletedId = parseInt(savedProgress, 10);
            const nextId = lastCompletedId + 1;
            if (nextId > 0 && nextId < {{ total_items }}) {
                console.log(`Resuming session. Redirecting to item ${nextId}...`);
                window.location.href = `/evaluate/${nextId}`;
            }
        }
    }
})();


// --- SCRIPT 2, 3 & 4: SESSION ID, PAN & ZOOM, and THEMING ---
// These scripts wait for the page's DOM to be fully loaded before running.
document.addEventListener('DOMContentLoaded', function() {
    
    // --- Define Shared Elements ---
    const viewer = document.getElementById('imageViewer');
    
    // --- MODIFICATION: Anonymous Session ID Management Script ---
    (function() {
        const sessionKey = 'anonymousEvalSessionId';
        let sessionId = sessionStorage.getItem(sessionKey);

        // Function to generate a simple UUID (Universally Unique Identifier)
        function generateUUID() {
            // This creates a UUID based on the browser's crypto API for randomness.
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        // If no session ID exists in sessionStorage, create one.
        // sessionStorage persists only for the duration of the page session (i.e., while the tab is open).
        if (!sessionId) {
            sessionId = generateUUID();
            sessionStorage.setItem(sessionKey, sessionId);
            console.log(`New anonymous session started: ${sessionId}`);
        }

        // Find the hidden input field and set its value to the session ID.
        const sessionIdInput = document.getElementById('sessionIdInput');
        if (sessionIdInput) {
            sessionIdInput.value = sessionId;
        }
    })();
    
    // --- Pan & Zoom Functionality ---
    (function() {
        if (!viewer) return;
        const container = document.getElementById('imageContainer');
        const image = document.getElementById('evaluationImage');
        const zoomLevelDisplay = document.getElementById('zoomLevel');
        
        let scale = 1, translateX = 0, translateY = 0, isPanning = false;
        let startX = 0, startY = 0, lastX = 0, lastY = 0;
        
        const MIN_SCALE = 0.5, MAX_SCALE = 10, ZOOM_SPEED = 0.1;
        
        const updateTransform = () => {
            if (container) {
                container.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            }
            if (zoomLevelDisplay) {
                zoomLevelDisplay.textContent = `${Math.round(scale * 100)}%`;
            }
        };
        
        const centerImage = () => {
            translateX = 0;
            translateY = 0;
            updateTransform();
        };

        if (image) {
            if (image.complete) {
                centerImage();
            } else {
                image.onload = () => centerImage();
            }
        }
        
        viewer.addEventListener('wheel', e => {
            e.preventDefault();
            const rect = viewer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left - (rect.width / 2);
            const mouseY = e.clientY - rect.top - (rect.height / 2);
            const delta = e.deltaY > 0 ? -ZOOM_SPEED : ZOOM_SPEED;
            const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale * (1 + delta)));
            
            if (newScale !== scale) {
                const pointX = (mouseX - translateX) / scale;
                const pointY = (mouseY - translateY) / scale;
                scale = newScale;
                translateX = mouseX - pointX * scale;
                translateY = mouseY - pointY * scale;
                updateTransform();
            }
        });
        
        viewer.addEventListener('mousedown', e => {
            if (e.button === 0) {
                isPanning = true;
                viewer.classList.add('grabbing');
                startX = e.clientX;
                startY = e.clientY;
                lastX = translateX;
                lastY = translateY;
                e.preventDefault();
            }
        });
        
        document.addEventListener('mousemove', e => {
            if (isPanning) {
                translateX = lastX + (e.clientX - startX);
                translateY = lastY + (e.clientY - startY);
                updateTransform();
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isPanning) {
                isPanning = false;
                viewer.classList.remove('grabbing');
            }
        });
        
        viewer.addEventListener('dblclick', () => { scale = 1; centerImage(); });
        
        window.zoomIn = () => { scale = Math.min(MAX_SCALE, scale * 1.2); updateTransform(); };
        window.zoomOut = () => { scale = Math.max(MIN_SCALE, scale / 1.2); updateTransform(); };
        window.resetZoom = () => { scale = 1; centerImage(); };
        
        document.addEventListener('keydown', e => {
            if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                const keyMap = { '+': zoomIn, '=': zoomIn, '-': zoomOut, '_': zoomOut, '0': resetZoom };
                if (keyMap[e.key]) keyMap[e.key]();
            }
        });
    })();

    // --- Random Gradient & Theming ---
    (function() {
        const rootStyles = getComputedStyle(document.documentElement);
        const sharedColor1 = rootStyles.getPropertyValue('--brand-primary-dark').trim();
        const sharedColor2 = rootStyles.getPropertyValue('--brand-primary-light').trim();

        if (viewer) {
            const randomStartAngle = Math.floor(Math.random() * 360);
            const numStops = Math.floor(Math.random() * (10 - 4 + 1)) + 4;
            const angleStep = 360 / numStops;
            let stops = Array.from({ length: numStops }, (_, i) => 
                `${i % 2 === 0 ? sharedColor1 : sharedColor2} ${i * angleStep}deg`
            );
            stops.push(`${sharedColor1} 360deg`);
            viewer.style.background = `conic-gradient(from ${randomStartAngle}deg at 50% 50%, ${stops.join(', ')})`;
        }

        const counter = document.querySelector('.item-counter');
        if (counter) {
            const randomAngle = Math.floor(Math.random() * 360);
            counter.style.background = `linear-gradient(${randomAngle}deg, ${sharedColor1}, ${sharedColor2})`;
        }

        const formSections = document.querySelectorAll('.form-section');
        formSections.forEach(section => {
            if (section.querySelector('.radio-group') || section.querySelector('.rating-options')) {
                let randomHue;
                do {
                    randomHue = Math.floor(Math.random() * 360);
                } while (randomHue > 60 && randomHue < 120);
                const randomAccentColor = `oklch(0.6 0.2 ${randomHue})`;
                section.style.setProperty('--random-accent-color', randomAccentColor);
            }
        });

        const evalIdStrong = document.querySelector('.eval-id strong');
        if (evalIdStrong) {
            const randomAngle = Math.floor(Math.random() * 360);
            const gradient = `linear-gradient(${randomAngle}deg, ${sharedColor1}, ${sharedColor2})`;
            evalIdStrong.style.background = gradient;
            evalIdStrong.style.webkitBackgroundClip = 'text';
            evalIdStrong.style.backgroundClip = 'text';
            evalIdStrong.style.color = 'transparent';
        }
    })();
});
</script>
</body>
</html>